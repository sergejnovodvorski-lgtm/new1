import streamlit as st
import gspread
import pandas as pd
import json
import re 
from datetime import datetime, timedelta
import time
import urllib.parse 




# =========================================================
# 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò
# =========================================================


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
if 'critical_error' not in st.session_state:
    st.session_state.critical_error = None
    
print("--- 1. –ù–∞—á–∞–ª–æ: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç ---") 


SPREADSHEET_NAME = "Start" 
WORKSHEET_NAME_ORDERS = "–ó–ê–Ø–í–ö–ò"
MANAGER_WHATSAPP_PHONE = "79000000000" 


st.set_page_config(
    page_title="CRM: –í–≤–æ–¥ –ù–æ–≤–æ–π –ó–∞—è–≤–∫–∏", 
    layout="wide",
    initial_sidebar_state="expanded"
)
print("--- 1. –ö–æ–Ω–µ—Ü: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞–Ω–∞ ---") 




# =========================================================
# 2. –§–£–ù–ö–¶–ò–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ò –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø
# =========================================================


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –≤ session_state
def set_critical_error(message, error_details=None):
    full_message = f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {message}"
    if error_details:
        full_message += f"\n\n–î–µ—Ç–∞–ª–∏: {error_details}"
    st.session_state.critical_error = full_message
    print(f"!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –£–°–¢–ê–ù–û–í–õ–ï–ù–ê: {message} --- {error_details} !!!")


@st.cache_resource(ttl=3600)
def get_gsheet_client():
    """–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Google Sheets API (st.secrets)."""
    
    print("--- 2.1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ gspread... ---") 
    
    if "gcp_service_account" not in st.secrets:
        set_critical_error("–°–µ–∫—Ä–µ—Ç 'gcp_service_account' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Streamlit Secrets.", 
                           "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Streamlit Cloud.")
        return None 
        
    try:
        gc = gspread.service_account_from_dict(st.secrets["gcp_service_account"])
        print("--- 2.1. –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ gspread. ---")
        return gc
    except Exception as e:
        set_critical_error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ gspread.", 
                           f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ä–µ—Ç–∞ 'gcp_service_account'. –û—à–∏–±–∫–∞: {e}")
        return None




@st.cache_data(ttl="1h")
def load_price_list():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ª–∏—Å—Ç '–ü–†–ê–ô–°' –≤ DataFrame pandas."""
    print(f"--- 2.2. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –∏–∑: {SPREADSHEET_NAME} (–ª–∏—Å—Ç '–ü–†–ê–ô–°')... ---")
    
    gc = get_gsheet_client()
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω, –∑–Ω–∞—á–∏—Ç, –æ—à–∏–±–∫–∞ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ session_state
    if not gc: return pd.DataFrame() 
        
    try:
        sh = gc.open(SPREADSHEET_NAME) 
        worksheet = sh.worksheet("–ü–†–ê–ô–°") 
        data = worksheet.get_all_records()
        df = pd.DataFrame(data)
        
        if '–¶–ï–ù–ê' in df.columns:
            df['–¶–ï–ù–ê'] = pd.to_numeric(df['–¶–ï–ù–ê'], errors='coerce')
        
        st.info(f"‚úÖ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(df)} –ø–æ–∑–∏—Ü–∏–π.")
        print(f"--- 2.2. –£—Å–ø–µ—à–Ω–æ: –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. {len(df)} —Å—Ç—Ä–æ–∫. ---") 
        return df
    
    except gspread.exceptions.SpreadsheetNotFound:
        set_critical_error(f"Google –¢–∞–±–ª–∏—Ü–∞ '{SPREADSHEET_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", 
                           "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç: 'Start'.")
    except gspread.exceptions.WorksheetNotFound:
        set_critical_error("–õ–∏—Å—Ç '–ü–†–ê–ô–°' –Ω–µ –Ω–∞–π–¥–µ–Ω.", 
                           "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–∏—Å—Ç '–ü–†–ê–ô–°' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞–∑–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É).")
    except Exception as e:
        set_critical_error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–π—Å–∞.", 
                           f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –∏ –¶–ï–ù–ê) –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞. –û—à–∏–±–∫–∞: {e}")
        
    return pd.DataFrame()




@st.cache_resource
def get_orders_worksheet():
    """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç –ª–∏—Å—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞—è–≤–æ–∫."""
    print(f"--- 2.3. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏—Å—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞—è–≤–æ–∫: '{WORKSHEET_NAME_ORDERS}'... ---")
    
    gc = get_gsheet_client()
    if not gc: return None
    try:
        sh = gc.open(SPREADSHEET_NAME) 
        worksheet = sh.worksheet(WORKSHEET_NAME_ORDERS)
        print(f"--- 2.3. –£—Å–ø–µ—à–Ω–æ: –õ–∏—Å—Ç '{WORKSHEET_NAME_ORDERS}' –ø–æ–ª—É—á–µ–Ω. ---")
        return worksheet
    except gspread.exceptions.WorksheetNotFound:
         set_critical_error(f"–õ–∏—Å—Ç –¥–ª—è –∑–∞—è–≤–æ–∫ '{WORKSHEET_NAME_ORDERS}' –Ω–µ –Ω–∞–π–¥–µ–Ω.", 
                           "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–∏—Å—Ç '–ó–ê–Ø–í–ö–ò' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞–∑–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.")
         return None
    except Exception as e:
        set_critical_error(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—Å—Ç—É '{WORKSHEET_NAME_ORDERS}'.", 
                           f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ. –û—à–∏–±–∫–∞: {e}")
        return None


# --- –ó–ê–ü–£–°–ö –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ---


print("--- 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∑–∞–ø—É—Å–∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π) ---") 


price_df = load_price_list() 
orders_ws = get_orders_worksheet()


# =========================================================
# –ü–†–û–í–ï–†–ö–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö –ò –ü–†–ï–ö–†–ê–©–ï–ù–ò–ï –ò–°–ü–û–õ–ù–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê
# =========================================================


if st.session_state.critical_error:
    st.error("üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò")
    st.markdown(f"**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑-–∑–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–±–ª–µ–º—ã:**")
    st.code(st.session_state.critical_error, language='markdown')
    # –ú—ã –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º st.stop(), –ø—Ä–æ—Å—Ç–æ –Ω–µ —Ä–∏—Å—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    # –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—á–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
else:
    # -----------------------------------------------------------
    # –ï–°–õ–ò –û–®–ò–ë–û–ö –ù–ï–¢, –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø –ó–î–ï–°–¨
    # -----------------------------------------------------------


    if price_df.empty: 
        print("--- 3.1. –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –ø—É—Å—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≥–ª—É—à–∫–∏. ---")
        price_items = ["--- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é ---"]
        # –î–æ–±–∞–≤–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ –ø—Ä–∞–π—Å –ø—É—Å—Ç
        st.warning("‚ö†Ô∏è –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–∑–∏—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏—Å—Ç '–ü–†–ê–ô–°'.")
    else:
        print(f"--- 3.1. –ü—Ä–∞–π—Å-–ª–∏—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç {len(price_df)} –ø–æ–∑–∏—Ü–∏–π. ---")
        price_items = ["--- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é ---"] + price_df['–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï'].tolist()


    if 'calculator_items' not in st.session_state:
        st.session_state.calculator_items = []
        print("--- 3.2. st.session_state.calculator_items –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. ---") 
        
    print("--- 3. –ö–æ–Ω–µ—Ü: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---") 


    # =========================================================
    # 4. –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–ò–°–ò –î–ê–ù–ù–´–• –í GOOGLE SHEETS
    # (–û—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    # =========================================================
    
    def save_data_to_gsheets(data_row):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç –ó–ê–Ø–í–ö–ò."""
        print(f"--- 4.1. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {data_row[:3]}... ---")
        if orders_ws is None:
            # –ï—Å–ª–∏ orders_ws None, –∑–Ω–∞—á–∏—Ç, —É–∂–µ –±—ã–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –Ω–æ –º—ã –ø–µ—Ä–µ—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
            st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ª–∏—Å—Ç—É –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.")
            return False
            
        try:
            orders_ws.append_row(data_row)
            print("--- 4.1. –£—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets. ---") 
            return True
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Google Sheets: {e}")
            print(f"!!! 4.1. –û–®–ò–ë–ö–ê –ó–ê–ü–ò–°–ò –≤ Google Sheets: {e} !!!") 
            return False


    # =========================================================
    # 5. –§–£–ù–ö–¶–ò–Ø –ü–ê–†–°–ò–ù–ì–ê –ü–ï–†–ï–ü–ò–°–ö–ò
    # (–û—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    # =========================================================


    def parse_conversation(text, price_items):
        """
        –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏.
        """
        # ... (–í–∞—à –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞) ...
        # –í —Ü–µ–ª—è—Ö —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º, 
        # –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –æ—à–∏–±–∫–∞ –Ω–µ –≤ –Ω–µ–π.


        print("--- 5. –ù–∞—á–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏) ---") 
        st.write("--- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ---")
        st.info("–§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.")
        # ...


    # --- –í–´–ó–û–í –û–°–ù–û–í–ù–û–ì–û –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ parse_conversation –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Ñ–æ—Ä–º—ã.
    # –î–ª—è —Ü–µ–ª–µ–π –æ—Ç–ª–∞–¥–∫–∏, –ø–æ–∫–∞–∂–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫:
    st.title("CRM: –í–≤–æ–¥ –ù–æ–≤–æ–π –ó–∞—è–≤–∫–∏")
    parse_conversation("–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞", price_items)